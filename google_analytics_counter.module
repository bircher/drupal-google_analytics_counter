<?php

/**
 * Load the necessary include files.
 */
module_load_include('inc', 'google_analytics_counter', 'google_analytics_counter_settings');
module_load_include('inc', 'google_analytics_counter', 'google_analytics_counter_data');

/**
 * Valid permissions for this module
 * @return array An array of valid permissions for the test_module module
 */
function google_analytics_counter_permission() {
  return array(
    'access google analytics counter' => array(
      'title' => t('Access Google Analytics Counter'),
      'description' => t('Set roles that may access the output of Google Analytics Counter.'),
      ),
    'administer google analytics counter' => array(
      'title' => t('Administer Google Analytics Counter'),
      'description' => t('Set roles that may access the settings of Google Analytics Counter.'),
      ),
    );
}

/**
 * Display help and module information
 * @param path which path of the site we're displaying help
 * @param arg array that holds the current path as would be returned from arg() function
 * @return help text for the path
 */
function google_analytics_counter_help($path, $arg) {
  // The line above outputs in ALL admin/module pages
  switch ($path) {
    case "admin/help/google_analytics_counter":
    return '<p>' . t("Page view counter drawing on data collected by Google Analytics.") . '</p>';
  }
}

/**
 * Menu for this module
 * @return array An array with this module's settings.
 */
function google_analytics_counter_menu() {
  $items = array();

  $items['admin/config/system/google_analytics_counter'] = array(
    'title' => 'Google Analytics Counter',
    'description' => 'Configure Google Analytics Counter module',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('google_analytics_counter_admin'),
    'access arguments' => array('administer google analytics counter'),
    'type' => MENU_NORMAL_ITEM,
    'weight' => 10,
    );

  $items['admin/config/system/google_analytics_counter/settings'] = array(
    'title' => 'Settings',
    'description' => 'General settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('google_analytics_counter_admin'),
    'access arguments' => array('administer google analytics counter'),
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'weight' => 0,
    );

  // A shortcut to the permissions settings for this module.
  $items['admin/config/system/google_analytics_counter/permissions'] = array(
    'title' => 'Permissions',
    'description' => 'Configure access permissions',
    'page callback' => 'google_analytics_counter_perms',
    'access arguments' => array('administer google analytics counter'),
    'type' => MENU_LOCAL_TASK,
    'weight' => 5,
    );

  return $items;
}

/**
 * Redirect to the module's permission settings. A callback from hook_menu().
 */
function google_analytics_counter_perms() {
  drupal_goto('admin/people/permissions', array('fragment' => 'module-google_analytics_counter'));
}

/**
 * Implements hook_block_info().
 */
function google_analytics_counter_block_info() {
  $block = array();

  // Generate listing of blocks from this module, for the admin/block page
  $block[0]["info"] = t("Google Analytics Counter");

  return $block;
}

/**
 * Implements hook_block_view().
 */
function google_analytics_counter_block_view($delta) {
  $block = array();

  // Generate our block content

  $block_content = google_analytics_counter_display();
  $block['subject'] = 'Google Analytics Counter';
  if ($block_content == '') { 
    // If unknown, for some reason.
    $block['content'] = t('N/A');
  }
  else {
    $block['content'] = $block_content;
  }

  return $block;
}

/**
 * Implements hook_filter_info().
 */
function google_analytics_counter_filter_info() {
  $filters = array();
  $filters['filter_google_analytics_counter'] = array(
    'title' => t('Google Analytics Counter tag'),
    'description' => t('Substitutes a special Google Analytics Counter tag [gac|...] with the actual content.'),
    'prepare callback' => 'google_analytics_counter_filter_google_analytics_counter_prepare',
    'process callback' => 'google_analytics_counter_filter_google_analytics_counter_process',
      //'tips callback' => '_filter_example_filter_time_tips',
    );
  return $filters;
}

function google_analytics_counter_filter_google_analytics_counter_prepare($text, $filter) {
  return $text;
}

function google_analytics_counter_filter_google_analytics_counter_process($text, $filter) {
  $text = replace_google_analytics_counter_tags($text);
  return $text;
}

function replace_google_analytics_counter_tags($str) {
  // [gac|path/to/page|debugon_or_debugoff]

  $matchlink = '';
  $orig_match = '';
  //preg_match_all("/(\[)gac(\|)[^\]]*(\])/s", $str, $matches);
  $matches = '';
  preg_match_all("/(\[)gac[^\]]*(\])/s", $str, $matches);

  foreach ($matches[0] as $match) {

    // Keep original value.
    $orig_match[] = $match;

    // Remove wrapping [].
    $match = substr($match, 1, (strlen($match) - 2));

    // Create an array of parameter attributions.
    $match = explode("|", $match);

    $path = trim(check_plain(@$match[1]));

    /* So now we can display the count based on the path.
     * If no path was defined, the function will detect the current page's count.
     */
    $matchlink[] = google_analytics_counter_display($path);
  }

  $str = str_replace($orig_match, $matchlink, $str);
  return $str;
}

/**
 * @todo Please document this function.
 */
function google_analytics_counter_display($path = '') {

  if ($path == '') {
    //$path = check_plain(implode('/', arg()));
    $path = check_plain($_GET['q']);
  }

  $block_content = '';
  $block_content .= '<span id="google-analytics-counter-' . md5($path) . '">';
  $count = google_analytics_counter_get_sum_per_path($path);
  if ($count == '') { 
    // If unknown, for some reason.
    $block_content .= t('N/A');
  }
  else {
    $block_content .= $count;
  }
  $block_content .= '</span>';

  return $block_content;
}

/**
 * @todo Please document this function.
 */
function google_analytics_counter_construct_content($sumarray) {

  $result = '';

  $sum_of_pageviews = '';

  $sum_of_pageviews .= @$sumarray[0];

  if (@$sumarray[0] == 0) {
    //@todo
    // If $sumarray[2] is zero, it means nothing was fetched (cache expired but there was concurrency and new data could not be retrieved). We will return nothing -- until new value can be retrieved.
    $result = '';
  }
  else {
    $result .= $sum_of_pageviews;
  }

  return $result;
}


/**
 * Implements hook_cron().
 *
 */
function google_analytics_counter_cron() {
  // Defaults to an hourly interval. Of course, cron has to be running at least hourly for this to work.
  $interval = 60*variable_get('google_analytics_counter_cron_interval', 60); // $interval must contain value in seconds.
  // We don't want to act every time cron runs (which could be every minute) so keep a time for the next run in a variable.
  if (time() >= variable_get('google_analytics_counter_cron_next_execution', 0)) {
    google_analytics_counter_update_path_counts();
    variable_set('google_analytics_counter_cron_next_execution', time() + $interval);
  }
  else {
    //watchdog('Google Analytics Counter', 'GA cron NOT running ... too little time passed!', NULL, WATCHDOG_ERROR);
  }
}
